<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>SVG Viewer</title>

        <style>
            html,
            body {
                margin: 0;
                width: 100%;
                height: 100%;
                background: #222;
                overflow: hidden;
            }

            #viewer {
                width: 100%;
                height: 100%;
                cursor: grab;
                overflow: hidden;
                position: relative;
            }

            #viewport {
                transform-origin: 0 0;
            }
        </style>
    </head>
    <body>
        <div id="viewer">
            <div id="viewport">
                <div id="svgHost"></div>
            </div>
        </div>

        <script>
            // Get the current host and port dynamically
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const host = window.location.host; // includes hostname:port if non-default
            
            // Build URL
            const wsUrl = `${protocol}://${host}/ws`;
            
            /* ---------- GET ID FROM URL ---------- */
            const params = new URLSearchParams(window.location.search);
            const id = params.get("id") || 0;
            const evtSource = new EventSource("/events");
            const ws = new WebSocket("ws://127.0.0.1:8000/ws");

            /* ---------- STATE ---------- */
            let scale = 1;
            let tx = 0;
            let ty = 0;
            let dragging = false;
            let lastX = 0;
            let lastY = 0;

            const viewer = document.getElementById("viewer");
            const viewport = document.getElementById("viewport");
            const svgHost = document.getElementById("svgHost");

            function applyTransform() {
                viewport.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
            }

            /* ---------- PAN ---------- */
            viewer.addEventListener("mousedown", (e) => {
                dragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            window.addEventListener("mousemove", (e) => {
                if (!dragging) return;
                tx += e.clientX - lastX;
                ty += e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
                applyTransform();
            });

            window.addEventListener("mouseup", () => {
                dragging = false;
            });

            /* ---------- ZOOM ---------- */
            viewer.addEventListener(
                "wheel",
                (e) => {
                    e.preventDefault();

                    const rect = viewer.getBoundingClientRect();

                    // Mouse position relative to viewport
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;

                    // Old scale
                    const oldScale = scale;

                    // Update scale
                    scale *= e.deltaY < 0 ? 1.1 : 0.9;

                    // Clamp scale to reasonable values
                    scale = Math.max(0.1, Math.min(10, scale));

                    // Adjust translation so the point under the mouse stays stationary
                    tx -= (mx - tx) * (scale / oldScale - 1);
                    ty -= (my - ty) * (scale / oldScale - 1);

                    applyTransform();
                },
                { passive: false },
            );
            
            ws.onmessage = async () => {
                const res = await fetch(`/current_svg/${id}`);
                svgHost.innerHTML = await res.text();
            };

            async function poll() {
                const res = await fetch(
                    `/current_svg/${encodeURIComponent(id)}`,
                );
                if (!res.ok) return;

                const svg = await res.text();
                console.log(svg)
                if (svg.trim())
                  svgHost.innerHTML = svg;
            }

            poll()
        </script>
    </body>
</html>
